---
import NavigationBar, { PageType } from '../components/NavigationBar.astro';
import Layout from '../layouts/BaseLayout.astro';

import createSlug from '../lib/createSlug';
import getBlogEntries from '../lib/getBlogEntries';
import formatDateSmall from '../lib/formatDateSmall';

interface RepoInfo {
  name: string,
  description: string | null,
  url: string,
  stargazerCount: number
}

// Get data from the Github GraphQl api
async function get_repo() {
  if (import.meta.env.PROD) {
    return await fetch('https://api.github.com/graphql', {
      method: 'post',
      headers: {
        Authorization: `bearer ${import.meta.env.GH_API_TOKEN}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        query:  `{
          user(login: "ahmedkhalf") {
            pinnedItems(first: 6, types: REPOSITORY) {
              nodes {
                ... on Repository {
                  name
                  description
                  url
                  stargazerCount
                }
              }
            }
          }
        }`})
      }).then((response) => response.json()).then(x => x.data.user.pinnedItems.nodes)
  } else {  // mock for the dev env
    return [
      {
        name: 'project.nvim',
        description: 'The superior project management solution for neovim.',
        url: 'https://github.com/ahmedkhalf/project.nvim',
        stargazerCount: 1315
      },
      {
        name: 'Circle-Evolution',
        description: 'Evolutionary Art Using Circles in Python',
        url: 'https://github.com/ahmedkhalf/Circle-Evolution',
        stargazerCount: 351
      },
      {
        name: 'Project207',
        description: 'Group Project for CSC207 UofT Summer 2022',
        url: 'https://github.com/The-CSC207-Group/Project207',
        stargazerCount: 2
      },
      {
        name: 'fen-to-image',
        description: 'Generate a chess board image given a FEN, Ã  la Lichess style.',
        url: 'https://github.com/Hart-House-Chess-Club/fen-to-image',
        stargazerCount: 1
      },
      {
        name: 'voxel-raytracer',
        description: null,
        url: 'https://github.com/ahmedkhalf/voxel-raytracer',
        stargazerCount: 0
      }
    ]
  }
}

const repoInfo = await get_repo() as [RepoInfo];
const nf = new Intl.NumberFormat('en-US');
const blogEntries = await getBlogEntries();
---

<Layout title="Ahmed Khalf">
  <NavigationBar pageType={PageType.Home} />
	<main>
    <div class="container">
      <h1>Ahmed Khalf</h1>
      <h2>Blog</h2>
      <table>
        <tbody>
          {blogEntries.map(async entry => {
            return (<tr><td class="left">{entry.data.date_published && formatDateSmall(entry.data.date_published)}:</td><td><a href={`/posts/${createSlug(entry.data.title)}`}>{entry.data.title}</a></td></tr>);
          })}
        </tbody>
      </table>

      <h2>Projects</h2>
      <table class="projects">
        <tbody>
          {repoInfo.map(entry => {
            return (<tr>
              <td class="left"><a href={entry.url}>{entry.name}</a></td>
              <td class="top">{entry.description}</td>
              {entry.stargazerCount !== 0 && <td class="right">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" class="star" aria-hidden="true" focusable="false"><path fill="currentColor" d="M287.9 0c9.2 0 17.6 5.2 21.6 13.5l68.6 141.3 153.2 22.6c9 1.3 16.5 7.6 19.3 16.3s.5 18.1-5.9 24.5L433.6 328.4l26.2 155.6c1.5 9-2.2 18.1-9.7 23.5s-17.3 6-25.3 1.7l-137-73.2L151 509.1c-8.1 4.3-17.9 3.7-25.3-1.7s-11.2-14.5-9.7-23.5l26.2-155.6L31.1 218.2c-6.5-6.4-8.7-15.9-5.9-24.5s10.3-14.9 19.3-16.3l153.2-22.6L266.3 13.5C270.4 5.2 278.7 0 287.9 0zm0 79L235.4 187.2c-3.5 7.1-10.2 12.1-18.1 13.3L99 217.9 184.9 303c5.5 5.5 8.1 13.3 6.8 21L171.4 443.7l105.2-56.2c7.1-3.8 15.6-3.8 22.6 0l105.2 56.2L384.2 324.1c-1.3-7.7 1.2-15.5 6.8-21l85.9-85.1L358.6 200.5c-7.8-1.2-14.6-6.1-18.1-13.3L287.9 79z"/></svg>
                {nf.format(entry.stargazerCount)}
              </td>}
            </tr>)
          })}
        </tbody>
      </table>
      
    </div>
	</main>
</Layout>

<style>
  main {
    margin: 0 1rem;
  }

	.container {
    margin: 0 auto;
    max-width: 40rem;
	}

  .left {
    vertical-align: top;
    padding-right: 0.5rem;
    padding-left: 0;
  }

  .top {
    vertical-align: top;
  }

  .right {
    vertical-align: top;
    padding-right: 0;
    padding-left: 1rem;
    white-space: nowrap;
  }

  .star {
    width: 1.1rem;
    height: 1.1rem;
    vertical-align: -0.125rem;
    margin-right: 0.25rem;
  }

  .projects tr {
    padding-bottom: 1rem;
  }
</style>
